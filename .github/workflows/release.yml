name: Release

permissions:
  contents: write

on:
    workflow_dispatch:
    push:
        branches:
            - 'main'
            - 'dev'
        tags:
            - 'v*.*.*'

jobs:
  build_plugin:
    runs-on: ubuntu-latest
    container:
        image: archlinux:latest
    steps:
      - name: set git global safe directory
        run: |
          pacman -Syu git npm tree zip unzip upx --noconfirm
          git config --global --add safe.directory $(realpath .)

      - uses: actions/checkout@v4

      # - name: submodules
      #   run: |
      #     git submodule update --init --recursive py_modules

      # - name: change log level
      #   run: |
      #     sed -i 's/logging.DEBUG/logging.INFO/' py_modules/config.py

      - name: build plugin
        run: |
          npm i -g pnpm
          pnpm config set registry https://registry.npmmirror.com/
          pnpm install --no-frozen-lockfile
          pnpm update @decky/ui --latest
          pnpm update @decky/api --latest
          pnpm run build

          rm -f dist/*.js.map

          mkdir -p MangoPeel
          cp -r dist *.py *.json *.md *.js LICENSE MangoPeel
          tar -czvf MangoPeel.tar.gz MangoPeel

          # zip
          zip -r MangoPeel.zip MangoPeel
          rm -rf MangoPeel
      
      - name: show files
        run: |
          tar -tzvf MangoPeel.tar.gz
          unzip -l MangoPeel.zip
          
      - name: Publish Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MangoPeel
          path: |
            MangoPeel.tar.gz
            MangoPeel.zip

  publish:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: build_plugin
    steps:
      - run: mkdir /tmp/artifacts

      - name: download artifact
        uses: actions/download-artifact@v4
        with:
          path: /tmp/artifacts

      - run: ls -R /tmp/artifacts

      - name: publish to github release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            /tmp/artifacts/MangoPeel/MangoPeel.tar.gz
            /tmp/artifacts/MangoPeel/MangoPeel.zip
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: contains(github.ref, 'pre') || contains(github.ref, '.rc')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}